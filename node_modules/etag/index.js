/*!
 * etag
<<<<<<< HEAD
 * Copyright(c) 2014-2016 Douglas Christopher Wilson
=======
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
 * MIT Licensed
 */

'use strict'

/**
 * Module exports.
 * @public
 */

module.exports = etag

/**
 * Module dependencies.
 * @private
 */

var crypto = require('crypto')
var Stats = require('fs').Stats

/**
 * Module variables.
 * @private
 */

<<<<<<< HEAD
=======
var base64PadCharRegExp = /=+$/
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
var toString = Object.prototype.toString

/**
 * Generate an entity tag.
 *
 * @param {Buffer|string} entity
 * @return {string}
 * @private
 */

<<<<<<< HEAD
function entitytag (entity) {
  if (entity.length === 0) {
    // fast-path empty
    return '"0-2jmj7l5rSw0yVb/vlWAYkK/YBwk"'
=======
function entitytag(entity) {
  if (entity.length === 0) {
    // fast-path empty
    return '"0-1B2M2Y8AsgTpgAmY7PhCfg"'
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
  }

  // compute hash of entity
  var hash = crypto
<<<<<<< HEAD
    .createHash('sha1')
    .update(entity, 'utf8')
    .digest('base64')
    .substring(0, 27)
=======
    .createHash('md5')
    .update(entity, 'utf8')
    .digest('base64')
    .replace(base64PadCharRegExp, '')
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4

  // compute length of entity
  var len = typeof entity === 'string'
    ? Buffer.byteLength(entity, 'utf8')
    : entity.length

  return '"' + len.toString(16) + '-' + hash + '"'
}

/**
 * Create a simple ETag.
 *
 * @param {string|Buffer|Stats} entity
 * @param {object} [options]
 * @param {boolean} [options.weak]
 * @return {String}
 * @public
 */

<<<<<<< HEAD
function etag (entity, options) {
=======
function etag(entity, options) {
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
  if (entity == null) {
    throw new TypeError('argument entity is required')
  }

  // support fs.Stats object
  var isStats = isstats(entity)
  var weak = options && typeof options.weak === 'boolean'
    ? options.weak
    : isStats

  // validate argument
  if (!isStats && typeof entity !== 'string' && !Buffer.isBuffer(entity)) {
    throw new TypeError('argument entity must be string, Buffer, or fs.Stats')
  }

  // generate entity tag
  var tag = isStats
    ? stattag(entity)
    : entitytag(entity)

  return weak
    ? 'W/' + tag
    : tag
}

/**
 * Determine if object is a Stats object.
 *
 * @param {object} obj
 * @return {boolean}
 * @api private
 */

<<<<<<< HEAD
function isstats (obj) {
=======
function isstats(obj) {
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
  // genuine fs.Stats
  if (typeof Stats === 'function' && obj instanceof Stats) {
    return true
  }

  // quack quack
<<<<<<< HEAD
  return obj && typeof obj === 'object' &&
    'ctime' in obj && toString.call(obj.ctime) === '[object Date]' &&
    'mtime' in obj && toString.call(obj.mtime) === '[object Date]' &&
    'ino' in obj && typeof obj.ino === 'number' &&
    'size' in obj && typeof obj.size === 'number'
=======
  return obj && typeof obj === 'object'
    && 'ctime' in obj && toString.call(obj.ctime) === '[object Date]'
    && 'mtime' in obj && toString.call(obj.mtime) === '[object Date]'
    && 'ino' in obj && typeof obj.ino === 'number'
    && 'size' in obj && typeof obj.size === 'number'
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
}

/**
 * Generate a tag for a stat.
 *
 * @param {object} stat
 * @return {string}
 * @private
 */

<<<<<<< HEAD
function stattag (stat) {
=======
function stattag(stat) {
>>>>>>> 71339de0c80cefcb3f3de1403ae61821653d7ea4
  var mtime = stat.mtime.getTime().toString(16)
  var size = stat.size.toString(16)

  return '"' + size + '-' + mtime + '"'
}
